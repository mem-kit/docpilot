# MCP 调试功能说明

## 新增功能

我已经为 MCP 集成添加了完整的调试功能，帮助你诊断 MCP 工具调用问题。

### 🔍 调试按钮

在 Agent 模式下，你会看到三个新按钮：

1. **📋 配置** - 查看当前 MCP 配置
   - 显示工作空间信息
   - 显示配置的服务器
   - 显示所有可用工具及其参数
   - 点击后会弹出 JSON 格式的配置信息

2. **📝 日志** - 查看 MCP 操作日志
   - 打开调试面板，显示所有 MCP 操作日志
   - 实时记录工具加载、调用、成功和失败
   - 日志按类型分类：INFO（蓝色）、SUCCESS（绿色）、ERROR（红色）、DEBUG（灰色）

3. **🔄 刷新** - 手动刷新 MCP 工具
   - 重新加载当前工作空间的 `.mcp.txt` 配置
   - 重新获取所有 MCP 服务器的工具列表

### 📊 调试面板

点击 "📝 日志" 按钮后，会在屏幕右下角弹出调试面板：

- **实时日志显示** - 显示最近 50 条日志
- **日志分类** - 按类型用不同颜色标记
- **详细信息** - 点击展开查看完整的请求/响应数据
- **清空按钮** - 清除所有日志
- **关闭按钮** - 关闭调试面板

### 🔧 日志类型

#### INFO（蓝色）
- 开始加载 MCP 工具
- 请求 MCP 配置文件
- 正在从服务器加载工具
- 执行 MCP 工具

#### SUCCESS（绿色）
- 成功加载 MCP 配置
- 成功获取工具列表
- 工具执行成功

#### ERROR（红色）
- 加载配置失败
- 获取工具列表失败
- 工具执行失败

#### DEBUG（灰色）
- 查看配置
- 原始响应数据
- 详细的请求参数

### 🐛 调试工作流程

当 MCP 工具无法调用时，按照以下步骤排查：

#### 1. 检查配置
点击 "📋 配置" 按钮，确认：
- `hasConfig` 是否为 `true`
- `servers` 是否包含你的服务器
- `toolsCount` 是否大于 0
- `tools` 数组是否包含预期的工具

#### 2. 查看日志
点击 "📝 日志" 按钮，查找：
- 红色的 ERROR 日志
- 配置文件加载是否成功
- 工具列表获取是否成功
- 工具调用的具体错误信息

#### 3. 常见问题排查

**问题：配置文件加载失败**
```
❌ ERROR: 加载 MCP 配置失败: Failed to load MCP config: 404
```
**解决：** 确保 `.mcp.txt` 文件存在于工作空间目录

**问题：工具列表获取失败**
```
❌ ERROR: 获取工具列表失败: Failed to list MCP tools: 500
```
**解决：** 检查 MCP 服务器是否正常运行，URL 是否正确

**问题：工具调用失败**
```
❌ ERROR: 工具执行失败: tool_name
```
**解决：** 查看日志中的详细错误信息和参数

### 📝 日志示例

#### 成功的工具加载
```
[11:23:45] INFO    开始加载 MCP 工具 - 工作空间: onboard
[11:23:45] INFO    请求 MCP 配置文件: http://...
[11:23:45] DEBUG   收到 MCP 配置文件 (length: 156)
[11:23:45] SUCCESS 成功解析 MCP 配置 (servers: ["camunda"])
[11:23:45] INFO    正在从服务器加载工具: camunda
[11:23:46] INFO    请求 MCP 工具列表: http://.../list_tools
[11:23:46] DEBUG   MCP 服务器响应 (toolsCount: 10)
[11:23:46] SUCCESS 获取到 10 个工具
[11:23:46] SUCCESS 从服务器 camunda 加载了 10 个工具
[11:23:46] SUCCESS 成功加载 10 个 MCP 工具
```

#### 工具调用
```
[11:24:30] INFO    执行 MCP 工具: list_definitions
              {
                "server": "camunda",
                "url": "http://...",
                "args": {}
              }
[11:24:31] SUCCESS 工具执行成功: list_definitions
              {
                "success": true,
                "data": {...}
              }
```

### 🎯 使用技巧

1. **保持日志面板开启** - 在测试 MCP 工具时，始终保持日志面板开启
2. **先查看配置** - 遇到问题时，先点击"配置"按钮确认设置正确
3. **清空旧日志** - 在新的测试前，点击"清空"按钮清除旧日志
4. **复制错误信息** - 可以从调试面板复制完整的错误信息用于报告

### 🔄 自动日志记录

系统会自动记录以下操作：
- ✅ 配置文件加载
- ✅ 工具列表获取
- ✅ 工具调用
- ✅ 所有网络请求和响应
- ✅ 错误和异常

所有日志也会同时输出到浏览器控制台（F12），便于开发者查看。

---

**提示：** 日志面板最多保存 50 条日志，超过后会自动删除最旧的日志。
