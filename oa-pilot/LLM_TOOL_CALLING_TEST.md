# LLM Tool Calling 测试指南

## 🎉 实现完成！

已成功集成 LLM (DeepSeek) 的 Function Calling 功能，可以通过自然语言指令操作 OnlyOffice 编辑器。

## ✅ 已实现的功能

### 1. 工具定义 (EngineDocument.js)
- ✅ 5个工具函数，支持参数传递
- ✅ OpenAI Function Calling 标准格式
- ✅ 详细的参数描述和类型定义

### 2. API 函数 (APIWord.js, APIExcel.js, APIPowerPoint.js)
- ✅ 所有函数改为异步，返回 Promise
- ✅ 支持 LLM 传递的参数
- ✅ 详细的执行结果反馈

### 3. 聊天面板 (ChatPanel.js)
- ✅ 集成 DeepSeek API
- ✅ 自动工具调用和执行
- ✅ 详细的执行过程显示
- ✅ 错误处理和重试机制
- ✅ Agent 模式开关

## 🧪 测试步骤

### 1. 启动应用
```bash
npm start
```

### 2. 打开浏览器
访问 http://localhost:3000

### 3. 准备文档
从左侧文件列表选择一个文档（Word、Excel 或 PowerPoint）

### 4. 激活 Agent 模式
点击右侧聊天面板的 "🔧 Load MCP" 按钮，激活 Agent 模式

### 5. 测试命令

#### Word 文档测试

**测试 1: 插入简单段落**
```
帮我在文档中插入一段文字："这是通过AI助手添加的新段落"
```

**测试 2: 插入格式化文本**
```
插入粗体文本："重要通知"
```

```
添加一段斜体加下划线的文字："注意事项"
```

**测试 3: 替换文本**
先在文档中选中一段文字，然后输入：
```
把选中的文字改成"已更新内容"
```

#### Excel 表格测试

**测试 1: 更新单元格**
```
在A1单元格写入"销售数据"
```

**测试 2: 格式化单元格**
```
在B2单元格写入粗体的"总计：1000"
```

**测试 3: 批量更新**
```
在C1单元格写入"备注"，在C2单元格写入"已完成"
```

#### PowerPoint 演示文稿测试

**测试 1: 更新第一张幻灯片**
```
把第一张幻灯片的标题改成"2024年度总结"
```

**测试 2: 更新其他幻灯片**
```
把第二张幻灯片的内容改成"项目进展报告"
```

## 📊 预期结果

每个命令执行后，您应该看到：

1. 🔧 **工具调用提示**
   ```
   🔧 正在执行: updateParagraph
   参数: {
     "text": "这是通过AI助手添加的新段落"
   }
   ```

2. ✅ **执行成功反馈**
   ```
   ✅ 执行成功
   成功插入段落: 这是通过AI助手添加的新段落
   ```

3. 🤖 **AI 总结**
   ```
   已成功在文档中插入新段落。内容为："这是通过AI助手添加的新段落"
   ```

4. 📄 **文档实时更新**
   左侧编辑器中的文档应该立即显示更改

## 🔍 调试技巧

### 查看控制台日志
按 F12 打开浏览器开发者工具，在 Console 中可以看到：
- 工具调用详情
- API 执行日志
- 错误信息

### 常见问题

**问题 1: 提示"编辑器未初始化"**
- 解决：等待文档完全加载后再发送命令
- 检查：左侧编辑器是否显示文档内容

**问题 2: 工具没有被调用**
- 解决：确保已点击 "Load MCP" 激活 Agent 模式
- 检查：看到 "🤖 Agent Mode Active" 标识

**问题 3: API 调用失败**
- 解决：检查 config.js 中的 llmAPIKey 和 llmURL
- 检查：网络连接是否正常

**问题 4: 文档没有更新**
- 解决：确认 OnlyOffice Document Server 正在运行
- 检查：baseURL 配置是否正确

## 🎯 高级测试

### 复杂命令测试
```
帮我创建一个包含三段内容的报告：
1. 第一段是粗体的标题"月度报告"
2. 第二段是正文"本月完成了所有目标任务"
3. 第三段是斜体的总结"期待下月继续努力"
```

### 多文档操作
1. 打开 Word 文档，添加内容
2. 切换到 Excel，更新数据
3. 切换到 PowerPoint，修改幻灯片

### 自然语言理解测试
```
把这段话加粗一下
```
```
给我在表格第一行第二列写个数字 100
```
```
更新PPT的第一页，写上我们公司的名字
```

## 📝 功能特点

### ✨ 智能参数推断
LLM 会根据用户的自然语言自动推断参数：
- 提取文本内容
- 识别格式要求（粗体、斜体等）
- 解析位置信息（单元格、幻灯片索引）

### 🔄 多轮对话支持
可以连续执行多个命令：
```
1. 在文档中添加标题
2. 然后添加一段正文
3. 最后添加结尾
```

### 🛡️ 错误处理
- 清晰的错误提示
- 失败原因说明
- 建议的解决方案

## 🚀 下一步：MCP 集成

当前已完成 LLM Function Calling 集成，接下来可以：

1. **集成 MCP 服务器**
   - 定义 MCP 协议通信
   - 实现工具发现机制
   - 支持动态工具注册

2. **扩展工具能力**
   - 添加更多文档操作
   - 支持图片和表格
   - 实现文档分析功能

3. **优化用户体验**
   - 添加工具执行动画
   - 支持撤销/重做
   - 实现批处理模式

## 📚 相关文档

- [EngineDocument.js](src/extensions/EngineDocument.js) - 工具定义
- [APIWord.js](src/extensions/APIWord.js) - Word API
- [APIExcel.js](src/extensions/APIExcel.js) - Excel API  
- [APIPowerPoint.js](src/extensions/APIPowerPoint.js) - PowerPoint API
- [ChatPanel.js](src/components/ChatPanel.js) - 聊天界面

## 🎊 总结

恭喜！您现在可以通过自然语言控制 OnlyOffice 编辑器了！

核心优势：
- 🧠 智能理解用户意图
- 🔧 自动选择和调用工具
- ✅ 实时反馈执行结果
- 🎯 准确执行文档操作

开始测试吧！如有问题，查看控制台日志或联系开发团队。
